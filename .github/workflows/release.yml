name: Build and Publish x86/x64

on:
  workflow_dispatch:

jobs:
  build-and-publish:
    runs-on: windows-latest
    outputs:
      timestamp: ${{ steps.set-timestamp.outputs.timestamp }}
      version: ${{ steps.set-timestamp.outputs.version }}

    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Restore
        run: dotnet restore memory/Memory.csproj
        shell: pwsh

      - name: Set timestamp and version
        id: set-timestamp
        run: |
          $ts = Get-Date -Format yyyyMMddHHmmss
          $version = "1.0.$ts"
          echo "timestamp=$ts" >> $env:GITHUB_OUTPUT
          echo "version=$version" >> $env:GITHUB_OUTPUT
          echo "VERSION=$version" >> $env:GITHUB_ENV
        shell: pwsh

      # --- x86 ---
      - name: Build x86
        run: dotnet build memory/Memory.csproj -c Release -r win-x86 --self-contained false --output ./build/x86
        shell: pwsh

      - name: Pack x86
        run: dotnet pack memory/Memory.csproj -c Release -p:PackageId=Memory-x86 -p:Version="$env:VERSION" --output ./nupkg/x86
        shell: pwsh

      - name: Push x86
        run: dotnet nuget push ./nupkg/x86/*.nupkg --api-key ${{ secrets.TOKEN }} --source "https://nuget.pkg.github.com/erfg12/index.json" --skip-duplicate
        shell: pwsh

      # --- x64 ---
      - name: Build x64
        run: dotnet build memory/Memory.csproj -c Release -r win-x64 --self-contained false --output ./build/x64
        shell: pwsh

      - name: Pack x64
        run: dotnet pack memory/Memory.csproj -c Release -p:PackageId=Memory-x64 -p:Version="$env:VERSION" --output ./nupkg/x64
        shell: pwsh

      - name: Push x64
        run: dotnet nuget push ./nupkg/x64/*.nupkg --api-key ${{ secrets.TOKEN }} --source "https://nuget.pkg.github.com/erfg12/index.json" --skip-duplicate
        shell: pwsh

      # Upload artifacts for the release job
      - name: Upload x86 artifact
        uses: actions/upload-artifact@v3
        with:
          name: x86-dll
          path: ./build/x86/Memory.dll

      - name: Upload x64 artifact
        uses: actions/upload-artifact@v3
        with:
          name: x64-dll
          path: ./build/x64/Memory.dll

  release:
    needs: build-and-publish
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v3

      - name: Download x86 artifact
        uses: actions/download-artifact@v3
        with:
          name: x86-dll
          path: ./artifacts/x86

      - name: Download x64 artifact
        uses: actions/download-artifact@v3
        with:
          name: x64-dll
          path: ./artifacts/x64

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build-and-publish.outputs.version }}
          name: Release v${{ needs.build-and-publish.outputs.version }}
          body: |
            Automated release for build ${{ needs.build-and-publish.outputs.timestamp }}
            
            ## Packages
            - Memory-x86 v${{ needs.build-and-publish.outputs.version }}
            - Memory-x64 v${{ needs.build-and-publish.outputs.version }}
          draft: false
          prerelease: false
          files: |
            ./artifacts/x86/Memory.dll
            ./artifacts/x64/Memory.dll
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}